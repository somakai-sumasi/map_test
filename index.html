<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>駅別 治安・家賃マップ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; }

    #info-bar {
      background: #1e293b;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
    }
    #map { height: calc(100vh - 36px); width: 100%; }

    .station-popup h3 {
      font-size: 15px;
      margin-bottom: 8px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 4px;
    }
    .station-popup table {
      font-size: 13px;
      border-collapse: collapse;
      width: 100%;
    }
    .station-popup td {
      padding: 3px 6px;
    }
    .station-popup td:first-child {
      font-weight: bold;
      white-space: nowrap;
      color: #555;
    }

    .safety-good { color: #16a34a; font-weight: bold; }
    .safety-normal { color: #ca8a04; font-weight: bold; }
    .safety-caution { color: #dc2626; font-weight: bold; }

    .legend-gradient {
      width: 120px; height: 14px;
      border-radius: 3px; border: 1px solid #ccc;
    }

    .legend {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 13px;
      line-height: 1.8;
    }
    .legend-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      font-size: 13px;
    }
    .legend-toggle::after {
      content: "▲";
      font-size: 10px;
      transition: transform 0.2s;
    }
    .legend.collapsed .legend-toggle::after {
      content: "▼";
    }
    .legend-body {
      padding: 0 14px 10px;
    }
    .legend.collapsed .legend-body {
      display: none;
    }
    .legend h4 { margin-bottom: 4px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-circle {
      width: 14px; height: 14px;
      border-radius: 50%; display: inline-block;
    }
    @media (max-width: 600px) {
      .legend.collapsed { min-width: auto; }
    }
  </style>
</head>
<body>
  <div id="info-bar">
    <span>阪神圏 <span id="station-count">-</span> 駅</span>
    <span style="margin-left:24px;">
      サイズ <input type="range" id="size-slider" min="2" max="16" value="7" style="vertical-align:middle;width:100px;">
      <span id="size-label">7</span>px
    </span>
    <label style="margin-left:20px;"><input type="checkbox" id="toggle-safety" checked> 治安</label>
    <label style="margin-left:8px;"><input type="checkbox" id="toggle-rent" checked> 家賃</label>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 平均・標準偏差を算出
    function calcStats(values) {
      const n = values.length;
      const mean = values.reduce((a, b) => a + b, 0) / n;
      const variance = values.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
      return { mean, stddev: Math.sqrt(variance) };
    }

    // 値を偏差ベースで 0〜1 に正規化（±2σ でクリップ）
    function deviationRatio(value, mean, stddev) {
      const z = (value - mean) / stddev;
      return Math.min(1, Math.max(0, (z + 2) / 4)); // -2σ→0, +2σ→1
    }

    // 犯罪率→色相（偏差ベース: 緑142→赤0）
    function crimeToHue(crimeRate, stats) {
      if (crimeRate == null) return null;
      const ratio = deviationRatio(crimeRate, stats.mean, stats.stddev);
      return 142 - ratio * 142;
    }

    // 家賃→明度（偏差ベース: 安い=明るい90%, 高い=暗い15%）
    function rentToLightness(rent, stats) {
      if (rent == null) return 50;
      const ratio = deviationRatio(rent, stats.mean, stats.stddev);
      return 90 - ratio * 75;
    }

    function markerColor(crimeRate, rent, crimeStats, rentStats, showSafety, showRent) {
      const hue = showSafety
        ? (crimeToHue(crimeRate, crimeStats) ?? 215)
        : 0;
      const s = showSafety
        ? (crimeRate != null ? 75 : 10)
        : 0;
      const l = showRent
        ? rentToLightness(rent, rentStats)
        : 50;
      return `hsl(${hue}, ${s}%, ${l}%)`;
    }

    const map = L.map("map").setView([34.7024, 135.4959], 11);

    L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
      maxZoom: 18,
    }).addTo(map);

    let allMarkers = [];
    let stationsData = [];
    let crimeStats = { mean: 0, stddev: 1 };
    let rentStats = { mean: 0, stddev: 1 };
    // 各駅の元のHSL成分を計算
    function calcHSL(s, showSafety, showRent) {
      const hue = showSafety ? (crimeToHue(s.crime_rate, crimeStats) ?? 215) : 0;
      const sat = showSafety ? (s.crime_rate != null ? 75 : 10) : 0;
      const l = showRent ? rentToLightness(s.rent_avg, rentStats) : 50;
      return { hue, sat, l };
    }

    // 重なるマーカーをグループ化して平均色を適用
    function updateColors() {
      const showSafety = document.getElementById("toggle-safety").checked;
      const showRent = document.getElementById("toggle-rent").checked;
      const currentRadius = Number(document.getElementById("size-slider").value);

      const hslValues = stationsData.map(s => calcHSL(s, showSafety, showRent));
      const pixelPos = stationsData.map(s => map.latLngToLayerPoint([s.lat, s.lng]));
      const threshold = currentRadius * 1.2;

      // Union-Find で重なるマーカーをグループ化
      const parent = stationsData.map((_, i) => i);
      function find(x) { return parent[x] === x ? x : (parent[x] = find(parent[x])); }
      function union(a, b) { parent[find(a)] = find(b); }

      const maxGeoDist = currentRadius * 0.001; // サイズに比例 (7px→約700m)

      for (let i = 0; i < stationsData.length; i++) {
        for (let j = i + 1; j < stationsData.length; j++) {
          const dlat = stationsData[i].lat - stationsData[j].lat;
          const dlng = stationsData[i].lng - stationsData[j].lng;
          if (dlat * dlat + dlng * dlng > maxGeoDist * maxGeoDist) continue;

          const dx = pixelPos[i].x - pixelPos[j].x;
          const dy = pixelPos[i].y - pixelPos[j].y;
          if (dx * dx + dy * dy < threshold * threshold) {
            union(i, j);
          }
        }
      }

      // グループごとにHSLを平均
      const groups = {};
      for (let i = 0; i < stationsData.length; i++) {
        const root = find(i);
        if (!groups[root]) groups[root] = [];
        groups[root].push(i);
      }

      Object.values(groups).forEach(group => {
        let avgH = 0, avgS = 0, avgL = 0;
        group.forEach(i => {
          avgH += hslValues[i].hue;
          avgS += hslValues[i].sat;
          avgL += hslValues[i].l;
        });
        const n = group.length;
        const color = `hsl(${avgH / n}, ${avgS / n}%, ${avgL / n}%)`;
        group.forEach(i => {
          allMarkers[i].setStyle({ fillColor: color, color: color });
        });
      });
    }

    fetch("stations.json")
      .then((res) => res.json())
      .then((stations) => {
        stationsData = stations;
        document.getElementById("station-count").textContent = stations.length;

        const rents = stations.filter((s) => s.rent_avg).map((s) => s.rent_avg);
        rentStats = calcStats(rents);

        const crimes = stations.filter((s) => s.crime_rate != null).map((s) => s.crime_rate);
        crimeStats = calcStats(crimes);

        stations.forEach((s) => {
          const color = markerColor(s.crime_rate, s.rent_avg, crimeStats, rentStats, true, true);

          const linesHtml = s.lines.join(", ");
          const safetyHtml = s.safety
            ? `<span class="safety-${s.safety_class}">${s.safety}</span>`
            + (s.crime_rate != null ? ` (${s.crime_rate}件/千人)` : "")
            : "-";
          const rentHtml = s.rent_avg ? `${s.rent_avg}万円` : "-";
          const cityHtml = s.city || "-";

          const popupHtml = `
            <div class="station-popup">
              <h3>${s.name}駅</h3>
              <table>
                <tr><td>路線</td><td>${linesHtml}</td></tr>
                <tr><td>所在地</td><td>${cityHtml}</td></tr>
                <tr><td>治安</td><td>${safetyHtml}</td></tr>
                <tr><td>家賃相場</td><td>${rentHtml}</td></tr>
              </table>
            </div>
          `;

          const marker = L.circleMarker([s.lat, s.lng], {
            radius: 7,
            color: color,
            fillColor: color,
            fillOpacity: 1,
            weight: 0,
          })
            .addTo(map)
            .bindPopup(popupHtml);
          allMarkers.push(marker);
        });

        // 凡例
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
          const div = L.DomUtil.create("div", "legend");
          const cm = crimeStats.mean.toFixed(1);
          const cs = crimeStats.stddev.toFixed(1);
          const rm = rentStats.mean.toFixed(1);
          const rs = rentStats.stddev.toFixed(1);
          div.innerHTML = `
            <div class="legend-toggle" onclick="this.parentElement.classList.toggle('collapsed')">凡例</div>
            <div class="legend-body">
              <h4>色相: 治安 (犯罪率/千人)</h4>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:11px;">-2σ</span>
                <div class="legend-gradient" style="background:linear-gradient(to right, hsl(142,75%,50%), hsl(90,75%,50%), hsl(45,75%,50%), hsl(20,75%,50%), hsl(0,75%,50%));"></div>
                <span style="font-size:11px;">+2σ</span>
              </div>
              <div style="font-size:11px;color:#888;margin-top:2px;">平均 ${cm}件/千人 (σ=${cs}) / 緑=少 → 赤=多</div>
              <div class="legend-item" style="margin-top:4px;"><span class="legend-circle" style="background:hsl(215,10%,50%)"></span> データなし</div>
              <hr style="margin:6px 0;border:none;border-top:1px solid #ddd;">
              <h4>明るさ: 家賃</h4>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:11px;">-2σ</span>
                <div class="legend-gradient" style="background:linear-gradient(to right, hsl(90,75%,90%), hsl(90,75%,52%), hsl(90,75%,15%));"></div>
                <span style="font-size:11px;">+2σ</span>
              </div>
              <div style="font-size:11px;color:#888;margin-top:2px;">平均 ${rm}万円 (σ=${rs}) / 明=安 → 暗=高</div>
              <hr style="margin:6px 0;border:none;border-top:1px solid #ddd;">
              <p style="font-size:11px;color:#666;">治安: 大阪府警・兵庫県警 犯罪オープンデータ(2024)<br>人口: 国勢調査(2020)<br>家賃: SUUMO家賃相場</p>
            </div>
          `;
          return div;
        };
        legend.addTo(map);
      });

    // ズーム変更時に重なりを再計算
    map.on("zoomend", updateColors);

    // サイズスライダー
    const slider = document.getElementById("size-slider");
    const sizeLabel = document.getElementById("size-label");
    slider.addEventListener("input", (e) => {
      const r = Number(e.target.value);
      sizeLabel.textContent = r;
      allMarkers.forEach((m) => m.setRadius(r));
      updateColors();
    });

    // 治安・家賃トグル
    document.getElementById("toggle-safety").addEventListener("change", updateColors);
    document.getElementById("toggle-rent").addEventListener("change", updateColors);
  </script>
</body>
</html>
