<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>駅別 治安・家賃マップ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: "Hiragino Sans", "Noto Sans JP", sans-serif; }

    #info-bar {
      background: #1e293b;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
    }
    #map { height: calc(100vh - 76px); width: 100%; }

    .station-popup h3 {
      font-size: 15px;
      margin-bottom: 8px;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 4px;
    }
    .station-popup table {
      font-size: 13px;
      border-collapse: collapse;
      width: 100%;
    }
    .station-popup td {
      padding: 3px 6px;
    }
    .station-popup td:first-child {
      font-weight: bold;
      white-space: nowrap;
      color: #555;
    }

    .safety-good { color: #16a34a; font-weight: bold; }
    .safety-normal { color: #ca8a04; font-weight: bold; }
    .safety-caution { color: #dc2626; font-weight: bold; }

    .legend-gradient {
      width: 120px; height: 14px;
      border-radius: 3px; border: 1px solid #ccc;
    }

    .legend {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 13px;
      line-height: 1.8;
    }
    .legend-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
      font-size: 13px;
    }
    .legend-toggle::after {
      content: "▲";
      font-size: 10px;
      transition: transform 0.2s;
    }
    .legend.collapsed .legend-toggle::after {
      content: "▼";
    }
    .legend-body {
      padding: 0 14px 10px;
    }
    .legend.collapsed .legend-body {
      display: none;
    }
    .legend h4 { margin-bottom: 4px; }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-circle {
      width: 14px; height: 14px;
      border-radius: 50%; display: inline-block;
    }
    /* フィルターパネル */
    #filter-bar {
      background: #0f172a;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 28px;
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .filter-label {
      color: #94a3b8;
      font-size: 12px;
      font-weight: bold;
      min-width: 32px;
    }
    .filter-value {
      color: #e2e8f0;
      font-size: 12px;
      min-width: 120px;
      font-variant-numeric: tabular-nums;
    }
    .filter-count {
      color: #64748b;
      font-size: 11px;
    }

    /* デュアルレンジスライダー */
    .dual-range {
      position: relative;
      width: 220px;
      height: 24px;
    }
    .dual-range .track {
      position: absolute;
      top: 7px;
      left: 0;
      right: 0;
      height: 10px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.15);
    }
    /* 選択範囲外を暗くするオーバーレイ */
    .dual-range .overlay-left,
    .dual-range .overlay-right {
      position: absolute;
      top: 7px;
      height: 10px;
      background: rgba(0,0,0,0.55);
      pointer-events: none;
      z-index: 1;
    }
    .dual-range .overlay-left {
      left: 0;
      border-radius: 5px 0 0 5px;
    }
    .dual-range .overlay-right {
      right: 0;
      border-radius: 0 5px 5px 0;
    }
    .dual-range input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 24px;
      background: transparent;
      pointer-events: none;
      margin: 0;
      z-index: 2;
    }
    .dual-range input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      border: 2px solid #334155;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
      cursor: pointer;
      pointer-events: auto;
    }
    .dual-range input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      border: 2px solid #334155;
      box-shadow: 0 1px 4px rgba(0,0,0,0.4);
      cursor: pointer;
      pointer-events: auto;
    }

    /* 治安トラック: 緑→赤 */
    .track-safety {
      background: linear-gradient(to right,
        hsl(142,75%,40%),
        hsl(90,75%,40%),
        hsl(45,75%,40%),
        hsl(20,75%,40%),
        hsl(0,75%,40%)
      );
    }
    /* 家賃トラック: 明→暗 */
    .track-rent {
      background: linear-gradient(to right,
        hsl(210,15%,85%),
        hsl(210,20%,65%),
        hsl(210,30%,45%),
        hsl(210,40%,28%),
        hsl(210,50%,12%)
      );
    }

    @media (max-width: 600px) {
      .legend.collapsed { min-width: auto; }
      .dual-range { width: 160px; }
      #filter-bar { gap: 12px; }
    }
  </style>
</head>
<body>
  <div id="info-bar">
    <span>阪神圏 <span id="station-count">-</span> 駅</span>
    <span style="margin-left:24px;">
      サイズ <input type="range" id="size-slider" min="2" max="16" value="7" style="vertical-align:middle;width:100px;">
      <span id="size-label">7</span>px
    </span>
    <label style="margin-left:20px;"><input type="checkbox" id="toggle-safety" checked> 治安</label>
    <label style="margin-left:8px;"><input type="checkbox" id="toggle-rent" checked> 家賃</label>
  </div>
  <div id="filter-bar">
    <div class="filter-group">
      <span class="filter-label">治安</span>
      <div class="dual-range" id="range-safety">
        <div class="track track-safety"></div>
        <div class="overlay-left"></div>
        <div class="overlay-right"></div>
        <input type="range" min="0" max="1000" value="0" step="1" data-role="min">
        <input type="range" min="0" max="1000" value="1000" step="1" data-role="max">
      </div>
      <span class="filter-value" id="safety-value">すべて</span>
    </div>
    <div class="filter-group">
      <span class="filter-label">家賃</span>
      <div class="dual-range" id="range-rent">
        <div class="track track-rent"></div>
        <div class="overlay-left"></div>
        <div class="overlay-right"></div>
        <input type="range" min="0" max="1000" value="0" step="1" data-role="min">
        <input type="range" min="0" max="1000" value="1000" step="1" data-role="max">
      </div>
      <span class="filter-value" id="rent-value">すべて</span>
    </div>
    <span class="filter-count" id="filter-count"></span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 平均・標準偏差を算出
    function calcStats(values) {
      const n = values.length;
      const mean = values.reduce((a, b) => a + b, 0) / n;
      const variance = values.reduce((a, b) => a + (b - mean) ** 2, 0) / n;
      return { mean, stddev: Math.sqrt(variance) };
    }

    // 値を偏差ベースで 0〜1 に正規化（±2σ でクリップ）
    function deviationRatio(value, mean, stddev) {
      const z = (value - mean) / stddev;
      return Math.min(1, Math.max(0, (z + 2) / 4)); // -2σ→0, +2σ→1
    }

    // 犯罪率→色相（偏差ベース: 緑142→赤0）
    function crimeToHue(crimeRate, stats) {
      if (crimeRate == null) return null;
      const ratio = deviationRatio(crimeRate, stats.mean, stats.stddev);
      return 142 - ratio * 142;
    }

    // 家賃→明度（偏差ベース: 安い=明るい90%, 高い=暗い15%）
    function rentToLightness(rent, stats) {
      if (rent == null) return 50;
      const ratio = deviationRatio(rent, stats.mean, stats.stddev);
      return 90 - ratio * 75;
    }

    function markerColor(crimeRate, rent, crimeStats, rentStats, showSafety, showRent) {
      const hue = showSafety
        ? (crimeToHue(crimeRate, crimeStats) ?? 215)
        : 0;
      const s = showSafety
        ? (crimeRate != null ? 75 : 10)
        : 0;
      const l = showRent
        ? rentToLightness(rent, rentStats)
        : 50;
      return `hsl(${hue}, ${s}%, ${l}%)`;
    }

    const map = L.map("map").setView([34.7024, 135.4959], 11);

    L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://maps.gsi.go.jp/development/ichiran.html">国土地理院</a>',
      maxZoom: 18,
    }).addTo(map);

    let allMarkers = [];
    let stationsData = [];
    let crimeStats = { mean: 0, stddev: 1 };
    let rentStats = { mean: 0, stddev: 1 };
    let baseRadius = 7;

    function radiusForZoom(zoom) {
      return Math.max(2, Math.round(baseRadius * (zoom / 11)));
    }
    // 各駅の元のHSL成分を計算
    function calcHSL(s, showSafety, showRent) {
      const hue = showSafety ? (crimeToHue(s.crime_rate, crimeStats) ?? 215) : 0;
      const sat = showSafety ? (s.crime_rate != null ? 75 : 10) : 0;
      const l = showRent ? rentToLightness(s.rent_avg, rentStats) : 50;
      return { hue, sat, l };
    }

    // 重なるマーカーをグループ化して平均色を適用
    function updateColors() {
      const showSafety = document.getElementById("toggle-safety").checked;
      const showRent = document.getElementById("toggle-rent").checked;
      const currentRadius = Number(document.getElementById("size-slider").value);

      const hslValues = stationsData.map(s => calcHSL(s, showSafety, showRent));
      const pixelPos = stationsData.map(s => map.latLngToLayerPoint([s.lat, s.lng]));
      const threshold = currentRadius * 1.2;

      // Union-Find で重なるマーカーをグループ化
      const parent = stationsData.map((_, i) => i);
      function find(x) { return parent[x] === x ? x : (parent[x] = find(parent[x])); }
      function union(a, b) { parent[find(a)] = find(b); }

      const maxGeoDist = currentRadius * 0.001; // サイズに比例 (7px→約700m)

      for (let i = 0; i < stationsData.length; i++) {
        for (let j = i + 1; j < stationsData.length; j++) {
          const dlat = stationsData[i].lat - stationsData[j].lat;
          const dlng = stationsData[i].lng - stationsData[j].lng;
          if (dlat * dlat + dlng * dlng > maxGeoDist * maxGeoDist) continue;

          const dx = pixelPos[i].x - pixelPos[j].x;
          const dy = pixelPos[i].y - pixelPos[j].y;
          if (dx * dx + dy * dy < threshold * threshold) {
            union(i, j);
          }
        }
      }

      // グループごとにHSLを平均
      const groups = {};
      for (let i = 0; i < stationsData.length; i++) {
        const root = find(i);
        if (!groups[root]) groups[root] = [];
        groups[root].push(i);
      }

      Object.values(groups).forEach(group => {
        let avgH = 0, avgS = 0, avgL = 0;
        group.forEach(i => {
          avgH += hslValues[i].hue;
          avgS += hslValues[i].sat;
          avgL += hslValues[i].l;
        });
        const n = group.length;
        const color = `hsl(${avgH / n}, ${avgS / n}%, ${avgL / n}%)`;
        group.forEach(i => {
          allMarkers[i].setStyle({ fillColor: color, color: color });
        });
      });
    }

    fetch("stations.json")
      .then((res) => res.json())
      .then((stations) => {
        stationsData = stations;
        document.getElementById("station-count").textContent = stations.length;

        const rents = stations.filter((s) => s.rent_avg).map((s) => s.rent_avg);
        rentStats = calcStats(rents);

        const crimes = stations.filter((s) => s.crime_rate != null).map((s) => s.crime_rate);
        crimeStats = calcStats(crimes);

        stations.forEach((s) => {
          const color = markerColor(s.crime_rate, s.rent_avg, crimeStats, rentStats, true, true);

          const linesHtml = s.lines.join(", ");
          let safetyHtml = "-";
          if (s.crime_rate != null) {
            const ratio = deviationRatio(s.crime_rate, crimeStats.mean, crimeStats.stddev);
            const label = ratio < 1/3 ? "良好" : ratio < 2/3 ? "普通" : "注意";
            const cls = ratio < 1/3 ? "good" : ratio < 2/3 ? "normal" : "caution";
            safetyHtml = `<span class="safety-${cls}">${label}</span> (${s.crime_rate}件/千人)`;
          }
          const rentHtml = s.rent_avg ? `${s.rent_avg}万円` : "-";
          const cityHtml = s.city || "-";

          const popupHtml = `
            <div class="station-popup">
              <h3>${s.name}駅</h3>
              <table>
                <tr><td>路線</td><td>${linesHtml}</td></tr>
                <tr><td>所在地</td><td>${cityHtml}</td></tr>
                <tr><td>治安</td><td>${safetyHtml}</td></tr>
                <tr><td>家賃相場</td><td>${rentHtml}</td></tr>
              </table>
            </div>
          `;

          const marker = L.circleMarker([s.lat, s.lng], {
            radius: radiusForZoom(map.getZoom()),
            color: color,
            fillColor: color,
            fillOpacity: 1,
            weight: 0,
          })
            .addTo(map)
            .bindPopup(popupHtml);
          allMarkers.push(marker);
        });

        // 凡例
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
          const div = L.DomUtil.create("div", "legend");
          const cm = crimeStats.mean.toFixed(1);
          const cs = crimeStats.stddev.toFixed(1);
          const rm = rentStats.mean.toFixed(1);
          const rs = rentStats.stddev.toFixed(1);
          div.innerHTML = `
            <div class="legend-toggle" onclick="this.parentElement.classList.toggle('collapsed')">凡例</div>
            <div class="legend-body">
              <h4>色相: 治安 (犯罪率/千人)</h4>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:11px;">-2σ</span>
                <div class="legend-gradient" style="background:linear-gradient(to right, hsl(142,75%,50%), hsl(90,75%,50%), hsl(45,75%,50%), hsl(20,75%,50%), hsl(0,75%,50%));"></div>
                <span style="font-size:11px;">+2σ</span>
              </div>
              <div style="font-size:11px;color:#888;margin-top:2px;">平均 ${cm}件/千人 (σ=${cs}) / 緑=少 → 赤=多</div>
              <div class="legend-item" style="margin-top:4px;"><span class="legend-circle" style="background:hsl(215,10%,50%)"></span> データなし</div>
              <hr style="margin:6px 0;border:none;border-top:1px solid #ddd;">
              <h4>明るさ: 家賃</h4>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:11px;">-2σ</span>
                <div class="legend-gradient" style="background:linear-gradient(to right, hsl(90,75%,90%), hsl(90,75%,52%), hsl(90,75%,15%));"></div>
                <span style="font-size:11px;">+2σ</span>
              </div>
              <div style="font-size:11px;color:#888;margin-top:2px;">平均 ${rm}万円 (σ=${rs}) / 明=安 → 暗=高</div>
              <hr style="margin:6px 0;border:none;border-top:1px solid #ddd;">
              <p style="font-size:11px;color:#666;">治安: 大阪府警・兵庫県警 犯罪オープンデータ(2024)<br>人口: 国勢調査(2020)<br>家賃: SUUMO家賃相場</p>
            </div>
          `;
          return div;
        };
        legend.addTo(map);

        // フィルター初期化
        initFilters();
        applyFilters();
      });

    // ズーム変更時にサイズ再計算 + 重なり再計算
    map.on("zoomend", () => {
      const r = radiusForZoom(map.getZoom());
      allMarkers.forEach((m) => m.setRadius(r));
      document.getElementById("size-slider").value = r;
      document.getElementById("size-label").textContent = r;
      updateColors();
    });

    // サイズスライダー（手動調整時は基準値も更新）
    const slider = document.getElementById("size-slider");
    const sizeLabel = document.getElementById("size-label");
    slider.addEventListener("input", (e) => {
      const r = Number(e.target.value);
      baseRadius = r * 11 / map.getZoom();
      sizeLabel.textContent = r;
      allMarkers.forEach((m) => m.setRadius(r));
      updateColors();
    });

    // 治安・家賃トグル
    document.getElementById("toggle-safety").addEventListener("change", updateColors);
    document.getElementById("toggle-rent").addEventListener("change", updateColors);

    // --- デュアルレンジ フィルタリング ---
    let crimeDataMin = 0, crimeDataMax = 16;
    let rentDataMin = 0, rentDataMax = 8;

    function initFilters() {
      const crimes = stationsData.filter(s => s.crime_rate != null).map(s => s.crime_rate);
      const rents = stationsData.filter(s => s.rent_avg != null).map(s => s.rent_avg);
      crimeDataMin = Math.floor(Math.min(...crimes) * 10) / 10;
      crimeDataMax = Math.ceil(Math.max(...crimes) * 10) / 10;
      rentDataMin = Math.floor(Math.min(...rents) * 10) / 10;
      rentDataMax = Math.ceil(Math.max(...rents) * 10) / 10;
    }

    function pctToValue(pct, dataMin, dataMax) {
      return dataMin + (pct / 1000) * (dataMax - dataMin);
    }

    // オーバーレイ（範囲外を暗く）を更新
    function updateOverlays(container) {
      const minInput = container.querySelector('[data-role="min"]');
      const maxInput = container.querySelector('[data-role="max"]');
      const minPct = Number(minInput.value) / 10;
      const maxPct = Number(maxInput.value) / 10;
      container.querySelector('.overlay-left').style.width = minPct + '%';
      container.querySelector('.overlay-right').style.width = (100 - maxPct) + '%';
    }

    // デュアルスライダーのイベント設定
    function setupDualRange(containerId) {
      const container = document.getElementById(containerId);
      const minInput = container.querySelector('[data-role="min"]');
      const maxInput = container.querySelector('[data-role="max"]');

      minInput.addEventListener('input', () => {
        if (Number(minInput.value) > Number(maxInput.value)) {
          minInput.value = maxInput.value;
        }
        updateOverlays(container);
        applyFilters();
      });
      maxInput.addEventListener('input', () => {
        if (Number(maxInput.value) < Number(minInput.value)) {
          maxInput.value = minInput.value;
        }
        updateOverlays(container);
        applyFilters();
      });

      updateOverlays(container);
    }

    function applyFilters() {
      const safetyContainer = document.getElementById("range-safety");
      const rentContainer = document.getElementById("range-rent");
      const safetyMinPct = Number(safetyContainer.querySelector('[data-role="min"]').value);
      const safetyMaxPct = Number(safetyContainer.querySelector('[data-role="max"]').value);
      const rentMinPct = Number(rentContainer.querySelector('[data-role="min"]').value);
      const rentMaxPct = Number(rentContainer.querySelector('[data-role="max"]').value);

      const filterCrimeMin = pctToValue(safetyMinPct, crimeDataMin, crimeDataMax);
      const filterCrimeMax = pctToValue(safetyMaxPct, crimeDataMin, crimeDataMax);
      const filterRentMin = pctToValue(rentMinPct, rentDataMin, rentDataMax);
      const filterRentMax = pctToValue(rentMaxPct, rentDataMin, rentDataMax);

      // ラベル更新
      const safetyLabel = document.getElementById("safety-value");
      const rentLabel = document.getElementById("rent-value");

      if (safetyMinPct <= 0 && safetyMaxPct >= 1000) {
        safetyLabel.textContent = "すべて";
      } else {
        safetyLabel.textContent = `${filterCrimeMin.toFixed(1)} 〜 ${filterCrimeMax.toFixed(1)} 件/千人`;
      }
      if (rentMinPct <= 0 && rentMaxPct >= 1000) {
        rentLabel.textContent = "すべて";
      } else {
        rentLabel.textContent = `${filterRentMin.toFixed(1)} 〜 ${filterRentMax.toFixed(1)} 万円`;
      }

      // マーカー表示/非表示
      let shown = 0;
      const isFullCrime = safetyMinPct <= 0 && safetyMaxPct >= 1000;
      const isFullRent = rentMinPct <= 0 && rentMaxPct >= 1000;

      stationsData.forEach((s, i) => {
        const crimeOk = isFullCrime || s.crime_rate == null
          || (s.crime_rate >= filterCrimeMin && s.crime_rate <= filterCrimeMax);
        const rentOk = isFullRent || s.rent_avg == null
          || (s.rent_avg >= filterRentMin && s.rent_avg <= filterRentMax);
        if (crimeOk && rentOk) {
          if (!map.hasLayer(allMarkers[i])) allMarkers[i].addTo(map);
          shown++;
        } else {
          if (map.hasLayer(allMarkers[i])) map.removeLayer(allMarkers[i]);
        }
      });

      document.getElementById("filter-count").textContent = `${shown} / ${stationsData.length} 駅表示`;
      document.getElementById("station-count").textContent = shown;
    }

    setupDualRange("range-safety");
    setupDualRange("range-rent");
  </script>
</body>
</html>
